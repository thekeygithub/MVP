<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.css" rel="stylesheet" />
		<script src="../js/mui.js"></script>
		<script src="../js/jquery-2.0.3.min.js"></script>
		<script type="text/javascript" src="../js/public.js"></script>
	</head>
	<style>
		.mui-bar-nav {
			-webkit-box-shadow:none;
			box-shadow:none;
		}
		.settlement-ul p{
			margin-top: 8px;
		}
		.settlement-ul li{
			padding: 1px 15px;
		}
		.settlement-ul:nth-of-type(2){
			margin-top: 10px;
		}
		.settlement-btn{
			width: 94%;
			margin: 20px auto 0;
		}
		.submit-btn{
			width: 94%;
			margin: 10px auto 0;
		}
		#modal{
			width: 100%;
			height: 100%;
			background-color: #000000;
			position: fixed;
			top: 0;
			left: 0;
			opacity: 0.8;
			overflow: hidden;
			display: none;
		}
		#modalDetail{
			width: 100%;
			height: 100px;
			background-color: #fff;
			margin-top: 300px;
			overflow: hidden;
		}
		#modalDetail p{
			font-size: 20px;
			height: 30px;
			line-height: 30px;
			margin-top: 35px;
			text-align: center;
			color: #000;
			opacity: 1;
		}
	</style>
	<body>
		<script type="text/javascript">
			mui.init()
		</script>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">异地就医登记</h1>
		</header>
		<div class="mui-content">
			<!-- <ul class="mui-table-view settlement-ul">
				<li class="mui-table-view-cell">
					<div class="mui-input-row mui-checkbox mui-left">
						<label>西药处方
							<p>妇科|李时明</p>
						</label>
						<input class="check listCheckBox" name="checkbox1" value="600" type="checkbox" >
					</div>
				</li>
				<li class="mui-table-view-cell">
					<div class="mui-input-row mui-checkbox mui-left">
						<label>西药处方
							<p>妇科|李时明</p>
						</label>
						<input class="check listCheckBox" name="checkbox1" value="300" type="checkbox" >
					</div>
				</li>
			</ul>
			<ul class="mui-table-view settlement-ul">
				<li class="mui-table-view-cell">
					<div class="mui-input-row mui-checkbox mui-left">
						<label>全选</label>
						<input class="checked" name="checkbox1" value="600" type="checkbox"  id="checkAll">
					</div>
				</li>
			</ul> -->
			<!-- <button type="button" class="mui-btn mui-btn-block mui-btn-green settlement-btn">结算</button> -->
			<form class="mui-input-group">
				<div class="mui-input-row">
					<label>社保卡号:</label>
					<input type="search" class="mui-input-clear" placeholder="请输入您的社保卡号" id="registerCardNum">
				</div>
				<div class="mui-input-row">
					<label>姓名</label>
					<input type="text" class="mui-input-clear" placeholder="请输入您的姓名" id="registerName">
				</div>
				<div class="mui-input-row">
					<label>性别：</label>
					<select name=""  id="registerSex">
						<option value="男">男</option>
						<option value="女">女</option>
					</select>
				</div>
				<div class="mui-input-row">
					<label>出生日期</label>
					<input type="date" class="mui-input-clear" placeholder="请输入您的出生日期" id="registerDate">
				</div>
				<div class="mui-input-row">
					<label>参保类别：</label>
					<select name="" id="registerInsuranceCategory">
						<option value="职工医保">职工医保</option>
						<option value="城乡居民医保">城乡居民医保</option>
						<option value="城镇居民医保">城镇居民医保</option>
						<option value="新农合">新农合</option>
					</select>
				</div>
				<div class="mui-input-row">
					<label>人员类别：</label>
					<select name="" id="registerPersonnelType">
						<option value="退休异地安置">退休异地安置</option>
						<option value="异地工作(学习)">异地工作(学习)</option>
						<option value="异地长期居住">异地长期居住</option>
						<option value="其他">其他</option>
					</select>
				</div>
				<div class="mui-input-row">
					<label>证件类别：</label>
					<select name="" id="registerCertificatesType">
						<option value="居民身份证">居民身份证</option>
						<option value="士官证">士官证</option>
						<option value="学生证">学生证</option>
						<option value="驾驶证">驾驶证</option>
						<option value="护照">护照</option>
						<option value="港澳通行证">港澳通行证</option>
					</select>
				</div>
				<div class="mui-input-row">
					<label>证件号:</label>
					<input type="text" class="mui-input-clear" placeholder="请输入证件号" id="registerCertificatesNum">
				</div>
				<div class="mui-input-row">
					<label>联系电话:</label>
					<input type="text" class="mui-input-clear" placeholder="请输入您的联系电话" id="registerPhone">
				</div>
				<!-- <div class="mui-input-row">
					<label>联系地址:</label>
					<input type="text" class="mui-input-clear" placeholder="请输入您的联系地址" id="registerAddress">
				</div> -->
				<div class="mui-input-row">
					<label>参保地地址:</label>
					<!-- <input type="text" class="mui-input-clear" placeholder="请输入您的参保地地址" id="registerInsuredAddress"> -->
					<select name="" id="registerInsuredAddress">
						<option value="北京市">北京市</option>
						<option value="上海市">上海市</option>
					</select>
				</div>
				<div class="mui-input-row">
					<label>就医城市:</label>
					<!-- <input type="text" class="mui-input-clear" placeholder="请输入您的就医城市" id="registerCity"> -->
					<select name="" id="registerCity" onchange="cityChange(this)">
						<option value=""></option>
						<option value="北京市">北京市</option>
						<option value="上海市">上海市</option>
					</select>
				</div>
				<div class="mui-input-row">
					<label>就医医院:</label>
					<!-- <input type="text" class="mui-input-clear" placeholder="请输入您的就医医院" id="registerHospital"> -->
					<select name="" id="registerHospital">
					</select>
				</div>
			</form>
			<button type="button" class="mui-btn mui-btn-block mui-btn-green submit-btn" onclick="submintData()">提交</button>
		</div>
		<div id="modal">
				<div id="modalDetail">
					<p id="modalInfo">验证中...</p>
				</div>
		</div>
	</body>
	<script type="text/javascript">
		var token=getUrlParam(document.URL,"jsessionid");
		var phone=getUrlParam(document.URL,"phone");
		var deviceType=getUrlParam(document.URL,"deviceType");
		var num=0;
		var info=["验证中...","正在验证社保卡基本信息...","正在验证社保卡头像信息...","正在验证人脸识别...","正在验证社保卡状态信息...","正在进行生物体征判断...","正在验证公安数据源信息...","正在验证国家机密特殊诊断信息...","正在验证国家机密特殊人员信息...","正在验证位置信息...","验证成功","数据正在提交"];
		$(function(){
			document.getElementById("registerCardNum").addEventListener("keypress",function(event) {    
				if(event.keyCode == "13") {       
					document.activeElement.blur();   
					// toSearch();//TODO 完成搜索事件          getSurveyInfoList
					getUserInfo($("#registerCardNum").val());
					event.preventDefault(); // 阻止默认事件---阻止页面刷新    
				}
			});
		});
		function cityChange(ev){
			var ht="";
			if(ev.value=="北京市"){
				ht+='<option value="卫生部北京医院">卫生部北京医院</option>';
				ht+='<option value="广安门中医院">广安门中医院</option>';
				$("#registerHospital").html(ht);
			}else if(ev.value=="上海市"){
				ht+='<option value="上海瑞金医院">上海瑞金医院</option>';
				ht+='<option value="上海同济医院">上海同济医院</option>';
				$("#registerHospital").html(ht);
			}
		}
		function getUserInfo(id){
			if(id =="" || !isCardNo(id)){
				mui.alert("请填写正确的社保卡号","提示","确认",submitFailCallback,{type:"div"});
			}else{
				var aoData=[];
				aoData.push({"name":"id","value":id});
				aoData.push({"name":"token","value":token});
				aoData.push({"name":"mobile","value":phone});
				$.ajax({
					url:''+getUrlBase()+'/applyController/getUserInfoBySocId',
					data:aoData,
					dataType:"json",
					type:'POST',
					headers:{},
					success:function(res){
						//成功后执行
						if(res.status){
							userInfoCallback(res.body)
						}else{
							mui.alert(""+res.message+"","提示","确认",submitFailCallback,{type:"div"});
						}
					},
					error: function(XMLHttpRequest, textStatus, errorThrown){
						mui.alert(""+textStatus+"","提示","确认",submitFailCallback,{type:"div"});
					}
				});	
			}
		}
		function userInfoCallback(obj){
			$("#registerName").val(obj.custname);
			$("#registerSex").val(obj.sex);
			$("#registerDate").val(getTimeStr(obj.birth_date,true));
			$("#registerCertificatesNum").val(obj.idcard);
			$("#registerPhone").val(obj.mobile);
			$("#registerInsuredAddress").val(obj.addr);
		}
		function submintData(){
			if($("#registerCardNum").val() =="" || !isCardNo($("#registerCardNum").val())){
				mui.alert("请填写正确的社保卡号","提示","确认",submitFailCallback,{type:"div"});
			}else{
				 try{
						window.android.toCheck();
						//window.android.toGACheck();
				 }catch(e){
				 }
			 }
		}
		function afterAndroidCheck(status){
			if(status==2){
				checkInfo()
							
			}else{
				failCallback();
			}
		}
		function checkInfo(){
			$("#modal").css("display","block");
				var time1 = setInterval(function(){
					if(num<=11){
						$("#modalInfo").html(info[num]);
					}else{
						$("#modal").css("display","none");
						window.clearInterval(time1);
						sendAjax();
					}
					num++;
				},500)
			
		}
		function sendAjax(){
				var dataList=[];
					dataList.push({"name":"register_user_name","value":$("#registerName").val()});
					dataList.push({"name":"register_user_sex","value":$("#registerSex").val()});
					dataList.push({"name":"user_birthday","value":toTimestamp($("#registerDate").val())});
					dataList.push({"name":"insurance_type","value":$("#registerInsuranceCategory").val()});
					dataList.push({"name":"personnel_type","value":$("#registerPersonnelType").val()});
					dataList.push({"name":"certificates_type","value":$("#registerCertificatesType").val()});
					dataList.push({"name":"certificates_num","value":$("#registerCertificatesNum").val()});
					dataList.push({"name":"register_user_phone","value":$("#registerPhone").val()});
					// dataList.push({"name":"register_address","value":$("#registerAddress").val()});
					dataList.push({"name":"insurance_address","value":$("#registerInsuredAddress").val()});
					dataList.push({"name":"medical_city","value":$("#registerCity").val()});
					dataList.push({"name":"medical_hospital","value":$("#registerHospital").val()});
					dataList.push({"name":"social_card","value":$("#registerCardNum").val()});
					dataList.push({"name":"token","value":token});
					dataList.push({"name":"mobile","value":phone});
				$.ajax({
					url:''+getUrlBase()+'/applyController/insertMedicalRegisteration',
					data:dataList,
					dataType:"json",
					type:'post',
					headers:{},
					success:function(res){
						//成功后执行
						if(res.status){
							successCallback()
						}else{
							mui.alert(""+res.message+"","提示","确认",submitFailCallback,{type:"div"});
						}
					}
				});	
			
		}
		function successCallback(){
			mui.alert("规定参保人员在异地入院后三日内向医保经办机构电话申报住院医院名称、地址、科室、床号、联系电话、病情，不按规定申报的，医保经办机构不予报销。医保经办机构在接到申报后根据该参保人员的此次住院病种、病情、病史等情况确定稽核方式。稽核方式有医保经办机构直接稽核、委托异地医保经办机构稽核、委托异地定点医院稽核。","提示","确认",submitCallback,{type:"div"});
		}
		function failCallback(){
		    mui.alert("验证失败，请重新验证","提示","确认",submitFailCallback,{type:"div"});
		}
		function submitCallback(){
			history.go(-1);
		}
		function submitFailCallback(){
		}
		function getUrlParam(xurl,name){
			var para="";
			if(xurl.lastIndexOf("?")>0){
				para=xurl.substring(xurl.lastIndexOf("?")+1,xurl.length);
				var arr=para.split("&");
				para="";
				for(var i=0;i<arr.length;i++){
				   if(arr[i].split("=")[0]==name) return arr[i].split("=")[1];
				}
				return "";
		   }else{
				return "";
		   }
		}
		function getTimeStr(t,isDateStr){
			if ( !isDateStr ) isDateStr = false;
			if ( !t ) return "";
			if ( t > -2 && t < 10 ) return "";
			try{
				var d=new Date(2013,1,1);
				d.setTime( t );
				var str = d.getFullYear()+"-"+getTwoNumberStr(d.getMonth()+1)+"-"+getTwoNumberStr(d.getDate());
				if ( !isDateStr ) str +=" "+getTwoNumberStr(d.getHours())+":"+getTwoNumberStr(d.getMinutes())
					+":"+getTwoNumberStr(d.getSeconds());
				return str;
			}catch(e){
				return "";
			}
		}
		function getTwoNumberStr(n){
			if ( n == '00' ) return '00';
			try{
				n=Number(n);
			}catch(e){}
			return ( n < 10 ) ? ("0"+n):n; 
		}
		function isCardNo(card){ 
			// 身份证号码为15位或者18位，15位时全为数字，18位前17位为数字，最后一位是校验位，可能为数字或字符X 
			var reg = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/; 
			if(reg.test(card) === false){ 
			return false; 
			}else{
				return true;
			} 
		}
	</script>
</html>
